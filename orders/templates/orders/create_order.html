{% extends 'base.html' %}
{% load sass_tags %}
{% load static %}
{% load carts_tags %}

{% block css %}
  <link rel="stylesheet" href="{% sass_src 'deps/css/orders.scss' %}" />
{% endblock %}

{% block content %}
  <main class="checkout-main">
    <div class="checkout-container">
      <div class="checkout-header">
        <h1 data-translate="checkout_title">Checkout</h1>
        <p data-translate="checkout_subtitle">Review your order and complete your purchase</p>
      </div>

      <div class="checkout-content">
        <div class="checkout-card">
          <div class="checkout-title">
            <h2 data-translate="order_summary">Order Summary</h2>
          </div>
          
          {% user_carts request as carts %}
          <div class="order-items">
            {% for cart in carts %}
              <div class="order-item">
                <div class="item-info">
                  <div class="item-name">{{ cart.product.name }}</div>
                  <div class="item-quantity"><span data-translate="quantity">Quantity:</span> {{ cart.quantity }}</div>
                </div>
                <div class="item-total">${{ cart.product.sell_price }}</div>
              </div>
            {% empty %}
              <p style="color: #999; text-align: center; padding: 2rem;" data-translate="your_cart_empty">Your cart is empty</p>
            {% endfor %}
          </div>

          {% if carts %}
            <div class="order-total">
              <span class="total-label" data-translate="total">Total:</span>
              <span class="total-amount">${{ total_price }}</span>
            </div>
          {% endif %}
        </div>

        <div class="checkout-card">
          <div class="checkout-title">
            <h2 data-translate="shipping_payment">Shipping & Payment</h2>
          </div>

          <form action="{% url 'orders:create_order' %}" method="post" class="checkout-form">
            {% csrf_token %}

            <div class="form-section">
              <div class="section-label" data-translate="personal_info">Personal Information</div>
              
              <div class="form-grid">
                <div class="form-field">
                  <label for="id_first_name" data-translate="first_name">First Name*</label>
                  <input 
                    type="text" 
                    id="id_first_name" 
                    name="first_name" 
                    placeholder="John"
                    value="{% if form.first_name.value %}{{ form.first_name.value }}{% endif %}"
                    required>
                  {% if form.first_name.errors %}
                    <div class="field-error">{{ form.first_name.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-field">
                  <label for="id_last_name" data-translate="last_name">Last Name*</label>
                  <input 
                    type="text" 
                    id="id_last_name" 
                    name="last_name" 
                    placeholder="Doe"
                    value="{% if form.last_name.value %}{{ form.last_name.value }}{% endif %}"
                    required>
                  {% if form.last_name.errors %}
                    <div class="field-error">{{ form.last_name.errors.0 }}</div>
                  {% endif %}
                </div>

                <div class="form-field form-field-full">
                  <label for="id_phone_number" data-translate="phone_number">Phone Number*</label>
                  <input 
                    type="text" 
                    id="id_phone_number" 
                    name="phone_number" 
                    placeholder="1234567890"
                    value="{% if form.phone_number.value %}{{ form.phone_number.value }}{% endif %}"
                    required>
                  {% if form.phone_number.errors %}
                    <div class="field-error">{{ form.phone_number.errors.0 }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="section-label" data-translate="delivery_method">Delivery Method</div>
              
              <div class="radio-group">
                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="requires_delivery" 
                    value="1" 
                    checked
                    onchange="toggleDeliveryAddress()">
                  <label style="margin: 0;" data-translate="delivery_address_opt">Delivery to Address</label>
                </label>

                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="requires_delivery" 
                    value="0"
                    onchange="toggleDeliveryAddress()">
                  <label style="margin: 0;" data-translate="pickup_store">Pickup in Store</label>
                </label>
              </div>

              <div class="form-field form-field-full optional-field" id="deliveryAddressField">
                <label for="id_delivery_address" data-translate="delivery_address">Delivery Address*</label>
                <textarea 
                  id="id_delivery_address" 
                  name="delivery_address" 
                  placeholder="Street address, city, state, ZIP code">{% if form.delivery_address.value %}{{ form.delivery_address.value }}{% endif %}</textarea>
                {% if form.delivery_address.errors %}
                  <div class="field-error">{{ form.delivery_address.errors.0 }}</div>
                {% endif %}
              </div>
            </div>

            <div class="form-section">
              <div class="section-label" data-translate="payment_method">Payment Method</div>
              
              <div class="radio-group">
                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="payment_on_get" 
                    value="0" 
                    checked>
                  <label style="margin: 0;" data-translate="credit_card">Credit/Debit Card</label>
                </label>

                <label class="radio-item">
                  <input 
                    type="radio" 
                    name="payment_on_get" 
                    value="1">
                  <label style="margin: 0;" data-translate="cash_on_delivery">Cash/Card on Delivery</label>
                </label>
              </div>
              {% if form.payment_on_get.errors %}
                <div class="field-error">{{ form.payment_on_get.errors.0 }}</div>
              {% endif %}
            </div>

            <button type="submit" class="checkout-button" data-translate="complete_order">Complete Order</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <script>
    function toggleDeliveryAddress() {
      const requiresDelivery = document.querySelector('input[name="requires_delivery"]:checked').value;
      const deliveryField = document.getElementById('deliveryAddressField');
      
      if (requiresDelivery === '1') {
        deliveryField.classList.remove('hidden');
        document.getElementById('id_delivery_address').required = true;
      } else {
        deliveryField.classList.add('hidden');
        document.getElementById('id_delivery_address').required = false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      toggleDeliveryAddress();
    });
  </script>
{% endblock %}
